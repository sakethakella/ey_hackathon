<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise RCA & CAPA Analytics Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hero-red-bg { background-color: #E4002B; } 
        .hero-red-text { color: #E4002B; }
        .card { @apply bg-white p-6 rounded-xl shadow-lg border border-gray-100; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rca-analytics-default-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        let state = {
            analyticsData: null
        };

        const mockGetFleetAnalytics = () => {
            const totalAnomalies = Math.floor(1200 + Math.random() * 200);
            const vehiclesAffected = Math.floor(800 + Math.random() * 100);
            
            return {
                summary: {
                    total_anomalies_30d: totalAnomalies,
                    unique_vehicles_affected: vehiclesAffected,
                    top_root_cause: {
                        code: "ENG_COOLANT_LEAK",
                        description: "Engine Coolant Leak due to faulty pressure cap.",
                        incidents: Math.floor(totalAnomalies * 0.18)
                    }
                },
                defect_clusters: [
                    { 
                        id: 1, 
                        title: "Engine overheating in slow traffic", 
                        description: "High correlation between ambient temperature > 35Â°C, low vehicle speed (< 10 km/h), and coolant temperature spikes.", 
                        vehicles: Math.floor(totalAnomalies * 0.25), 
                        models: ["Splendor XTEC", "Passion Pro E20"] 
                    },
                    { 
                        id: 2, 
                        title: "Rear-brake fade in downhill usage", 
                        description: "Rapid braking surface temperature rise exceeding specification during continuous downhill maneuvers.", 
                        vehicles: Math.floor(totalAnomalies * 0.08), 
                        models: ["Xpulse 200 4V"] 
                    },
                    { 
                        id: 3, 
                        title: "Intermittent starter motor failure", 
                        description: "Low battery voltage readings only observed on cold starts, suggesting high transient load.", 
                        vehicles: Math.floor(totalAnomalies * 0.15), 
                        models: ["Maestro Edge 125"] 
                    }
                ]
            };
        };

        const api = {
            getFleetAnalytics: async () => mockGetFleetAnalytics()
        };
        const renderHeader = () => {
            const header = document.createElement('header');
            header.className = 'sticky top-0 z-20 bg-white shadow-md px-6 py-3 flex justify-between items-center';
            header.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="lucide w-6 h-6 hero-red-text" data-lucide="bar-chart-3"></div>
                    <span class="text-xl font-bold text-gray-800">RCA & CAPA Analytics Portal</span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <span class="text-xs text-gray-500 mr-4">Analyst ID: ${userId || 'N/A'}</span>
                    <div class="lucide w-5 h-5 text-gray-500" data-lucide="briefcase"></div>
                </div>
            `;
            return header;
        };

        const renderRcaAnalytics = () => {
            const data = state.analyticsData;
            
            if (!data || !data.summary || !data.defect_clusters) {
                 document.getElementById('content').innerHTML = '<div class="p-12 text-center text-gray-500">Loading RCA data...</div>';
                 return;
            }

            const summary = data.summary;
            const clusters = data.defect_clusters;

            const mainContent = `
                <div class="p-8 max-w-7xl mx-auto space-y-8">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center space-x-3 border-b pb-4">
                        <div class="lucide w-8 h-8 hero-red-text" data-lucide="scan"></div>
                        <span>Fleet-Level Root Cause Analysis & Predictive Insights</span>
                    </h2>
                    
                    <!-- Analytics Summary Card -->
                    <div class="card grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="p-4 bg-red-50 rounded-lg">
                            <p class="text-5xl font-extrabold hero-red-text">${summary.total_anomalies_30d.toLocaleString()}</p>
                            <p class="text-sm text-gray-600 mt-1">Total Anomalies (Last 30 Days)</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-5xl font-extrabold text-blue-700">${summary.unique_vehicles_affected.toLocaleString()}</p>
                            <p class="text-sm text-gray-600 mt-1">Unique Vehicles Affected</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <p class="text-xl font-bold text-green-700">${summary.top_root_cause.code}</p>
                            <p class="text-sm text-gray-600 mt-1">Top Root Cause (${summary.top_root_cause.incidents.toLocaleString()} incidents)</p>
                            <p class="text-xs text-gray-500 mt-1 italic">${summary.top_root_cause.description}</p>
                        </div>
                    </div>

                    <!-- Defect Clustering Section -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center space-x-2">
                             <div class="lucide w-5 h-5 hero-red-text" data-lucide="layout-grid"></div>
                            <span>Identified Defect Clusters (CAPA Priority)</span>
                        </h3>
                        <div class="space-y-4">
                            ${clusters.map(cluster => `
                                <div class="p-4 rounded-xl border-l-4 ${cluster.id === 1 ? 'border-red-500 bg-red-50' : (cluster.id === 2 ? 'border-orange-500 bg-orange-50' : 'border-yellow-500 bg-yellow-50')} shadow-sm">
                                    <div class="flex justify-between items-center">
                                        <p class="font-bold text-lg text-gray-800">${cluster.id}. ${cluster.title}</p>
                                        <span class="text-sm font-semibold text-gray-700">${cluster.vehicles.toLocaleString()} Vehicles</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">${cluster.description}</p>
                                    <p class="text-xs text-gray-500 mt-2">Targeted Models: ${cluster.models.join(', ')}</p>
                                    <button class="mt-3 text-xs hero-red-text font-medium hover:underline flex items-center">
                                        <div class="lucide w-3 h-3 mr-1" data-lucide="download"></div>
                                        Initiate RCA Report
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- RCA Flow Diagram Context -->
                    <div class="card bg-gray-100 text-gray-600 text-sm italic border-none">
                        <p>The clustering analysis drives the Corrective and Preventive Actions (CAPA) process. We first identify clusters, then drill down to the Root Cause (RCA) to design a permanent fix (e.g., ECU patch, component redesign, or service bulletin).</p>
                        [Image of a Root Cause Analysis (RCA) flow diagram]
                    </div>
                </div>
            `;
            document.getElementById('content').innerHTML = mainContent;
            lucide.createIcons();
        };

        const render = async () => {
            const appDiv = document.getElementById('app');
            if (!isAuthReady) {
                appDiv.innerHTML = '<div class="p-12 text-center text-gray-500">Initializing Enterprise Authentication...</div>';
                return;
            }
            
            try {
                state.analyticsData = await api.getFleetAnalytics();
            } catch (e) {
                console.error("Error fetching analytics data:", e);
                appDiv.innerHTML = `<div class="p-12 text-center text-red-600">Error loading data: ${e.message}. Check console for details.</div>`;
                return;
            }

            if (!document.getElementById('header')) {
                appDiv.innerHTML = `<div id="header"></div><main id="content" class="flex-1"></main>`;
            }

            document.getElementById('header').innerHTML = '';
            document.getElementById('header').appendChild(renderHeader());

            renderRcaAnalytics();
        };
        const initVehicleApp = async () => {
            if (!auth) return;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    } catch (e) {
                        console.error("Anonymous sign-in failed:", e);
                        return;
                    }
                }
                isAuthReady = true;
                console.log("Authentication complete for Analyst. User ID:", userId);
                
                setInterval(render, 15000); 
                
                render();
            });
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("No custom token provided. Awaiting auth state change for anonymous sign-in.");
                }
            } catch (error) {
                console.error("Auth sign-in failed:", error);
            }
        };

        initVehicleApp();

    </script>
</body>
</html>
